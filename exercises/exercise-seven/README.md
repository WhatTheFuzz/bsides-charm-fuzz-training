# Exercise Five

## tl;dr

Modify the [harness](./harness.c) to fuzz `ossl_a2ulabel` to find CVE-2022-3786.

## Learning Objectives

- Use a harness to fuzz a library function.

## About

This exercise will walk us though fuzzing library functions using what's called a harness. A harness is a small program that calls the function we want to fuzz with the input generated by the fuzzer. In this case, we're going to fuzz out the bug in [openssl][openssl] that leads to [CVE-2022-3786][cve]. This bug is a buffer overflow on the stack. Take a look at the [patch][patch] that corrects the bug.

There is an included [harness](./harness.c) file which we will use to call the buggy function. Most of it has been filled out for you, but you will need to modify the arguments passed in to the function `ossl_a2ulabel` to match the function signature. Note that we'll want to pass in the input generated by the fuzzer as the first argument.

The project in this repository is a submodule. If you didn't already clone the submodules, make sure to do so with:

```shell
git submodule init
git submodule update --recursive
```

## Compilation

The included [Makefile](./Makefile) assumes that you've already compiled `openssl`. This is done for you by the Dockerfile, so if you're using Docker, skip to the [Docker](#docker) section.

```shell
# Navigate to the openssl directory.
cd openssl/
# Configure OpenSSL with ASAN for 32-bit.
AFL_USE_ASAN=1 CC=afl-gcc-fast CXX=afl-gcc++-fast ./Configure -m32 linux-generic32
# Compile OpenSSL with ASAN for 32-bit.
AFL_USE_ASAN=1 CC=afl-gcc-fast CXX=afl-gcc++-fast CFLAGS="-m32" CXXFLAGS="-m32" make --jobs `nproc`

# Move back up a directory and compile the harness.
cd ..
make
```

### Docker

Alternatively, use Docker to make your life easier.

```shell
# Navigate to the exercise directory, if you haven't already.
cd exercise-five

# Build the Docker image.
docker build --tag exercise-five .

# Run the container. Mounting a volume to persist the output.
# Note this will automatically run afl-fuzz. Add /bin/bash 
# to the end of the command to get a shell.
docker run --volume $(pwd)/output:/output --interactive --tty exercise-five:latest
```

## Usage

If you've built your harness correctly, you should be able to run `harness` without the fuzzer and have it print the return value from the program. This is useful for debugging your harness.

```shell
$ ./harness 
Usage: ./harness <file>

$ ./harness <example file> 
ossl_a2ulabel returned: -1
```

## The Goal

If you've set up your harness properly (adjusted the arguments to `ossl_a2ulabel`), you should be able to run the fuzzer and find the bug. Make note of the location of the crash and then reexamine the [patch][patch] to see how the bug was fixed. Is that line of code still there?

[openssl]: https://github.com/openssl/openssl
[cve]: https://nvd.nist.gov/vuln/detail/CVE-2022-3786
[patch]: https://git.openssl.org/gitweb/?p=openssl.git;a=commitdiff;h=c42165b5706e42f67ef8ef4c351a9a4c5d21639a